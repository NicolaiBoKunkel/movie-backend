services:
  db:
    image: postgres:16
    container_name: pgdb
    environment:
      POSTGRES_USER: ${PG_ADMIN_USER}
      POSTGRES_PASSWORD: ${PG_ADMIN_PASSWORD}
      POSTGRES_DB: ${PGDATABASE}
    ports:
      - "5432:5432"
    volumes:
      - ./db/sql/postgres:/docker-entrypoint-initdb.d
      - pgdata:/var/lib/postgresql/data

  db-init:
    image: postgres:16
    container_name: pgdb_init
    depends_on:
      - db
    volumes:
      - ./db/sql/postgres:/sql:ro
    environment:
      PGUSER: ${PG_ADMIN_USER}
      PGPASSWORD: ${PG_ADMIN_PASSWORD}
      PGHOST: db
      PGDATABASE: ${PGDATABASE}
      APP_DB_PW: ${APP_DB_PW}
      ADMIN_DB_PW: ${ADMIN_DB_PW}
    entrypoint: ["/bin/bash","/sql/db-init.sh"]

  seed-json:
    image: node:18
    container_name: seed_json
    depends_on:
      - db
    volumes:
      - ./:/usr/src/app
    working_dir: /usr/src/app
    environment:
      DATABASE_URL: postgres://postgres:postgres@db:5432/moviedb
      APP_DB_PW: ${APP_DB_PW}
    restart: "no"
    # Execute the script explicitly with bash to avoid shebang/CRLF issues
    entrypoint: ["bash", "/usr/src/app/scripts/docker/run_seed.sh"]

  pgadmin:
    image: dpage/pgadmin4:8
    container_name: pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD}
    ports:
      - "5050:80"
    volumes:
      - ./docker/pgadmin/servers.json:/pgadmin4/servers.json:ro
    depends_on:
      - db

  sfu-mongodb:
    build: ./docker/mongodb
    container_name: movie-mongo
    ports:
      - "27018:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MON_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MON_PASSWORD}
    volumes:
      - mongodata:/data/db

  mongo-express:
    image: mongo-express
    restart: always
    ports:
      - "8081:8081"
    environment:
      ME_CONFIG_MONGODB_SERVER: ${MON_HOST}
      ME_CONFIG_MONGODB_PORT: ${MON_PORT}
      ME_CONFIG_MONGODB_ADMINUSERNAME: ${MON_USERNAME}
      ME_CONFIG_MONGODB_ADMINPASSWORD: ${MON_PASSWORD}
      ME_CONFIG_BASICAUTH: "false"
    depends_on:
      - sfu-mongodb

  neo4j:
    image: neo4j:5.13-community
    container_name: neo4j-db
    ports:
      - "7474:7474"  # Neo4j Browser
      - "7687:7687"  # Bolt protocol
    environment:
      NEO4J_AUTH: ${NEO4J_AUTH}
      NEO4J_ACCEPT_LICENSE_AGREEMENT: "yes"
      NEO4J_dbms_memory_heap_initial__size: ${NEO4J_HEAP_INITIAL_SIZE}
      NEO4J_dbms_memory_heap_max__size: ${NEO4J_HEAP_MAX_SIZE}
      NEO4J_dbms_memory_pagecache_size: ${NEO4J_PAGECACHE_SIZE}
    volumes:
      - neo4jdata:/data
      - neo4jlogs:/logs

  backend:
    build:
      context: .
      target: development
    container_name: movie-backend
    ports:
      - "5000:5000"
    volumes:
      - ./src:/app/src
      - ./prisma:/app/prisma
      - /app/node_modules
    environment:
      NODE_ENV: development
      PORT: 5000
      DATABASE_URL: postgres://postgres:postgres@db:5432/moviedb
      PGHOST: db
      PGPORT: 5432
      PGDATABASE: ${PGDATABASE}
      PGUSER: ${PGUSER}
      PGPASSWORD: ${PGPASSWORD}
      MONGODB_URI: mongodb://${MON_USERNAME}:${MON_PASSWORD}@sfu-mongodb:27017/${MON_DATABASE}?authSource=admin
      MON_HOST: sfu-mongodb
      MON_PORT: 27017
      MON_USERNAME: ${MON_USERNAME}
      MON_PASSWORD: ${MON_PASSWORD}
      MON_DATABASE: ${MON_DATABASE}
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: ${NEO4J_USER}
      NEO4J_PASSWORD: ${NEO4J_PASSWORD}
      JWT_SECRET: ${JWT_SECRET}
    depends_on:
      - db
      - db-init
      - sfu-mongodb
      - neo4j

  frontend:
    build:
      context: ./frontend
      target: development
    container_name: movie-frontend
    ports:
      - "3000:3000"
    volumes:
      - ./frontend:/app
      - /app/node_modules
      - /app/.next
    environment:
      NODE_ENV: development
      NEXT_PUBLIC_API_URL: http://localhost:5000
      BACKEND_URL: http://backend:5000
      TMDB_API_KEY: ${TMDB_API_KEY}
    depends_on:
      - backend

volumes:
  pgdata:
  mongodata:
    driver: local
  neo4jdata:
    driver: local
  neo4jlogs:
    driver: local
