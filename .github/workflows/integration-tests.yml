name: Integration Tests

on:
  push:
    branches: [ main, master, Mikkel_branch_1, ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: movie_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      mongodb:
        image: mongo:latest
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: adminpass
        ports:
          - 27018:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand({ping: 1})'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      neo4j:
        image: neo4j:5.13-community
        env:
          NEO4J_AUTH: neo4j/testpassword
          NEO4J_ACCEPT_LICENSE_AGREEMENT: yes
        ports:
          - 7474:7474
          - 7687:7687
        options: >-
          --health-cmd "cypher-shell -u neo4j -p testpassword 'RETURN 1'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Setup environment variables
      run: |
        cat > .env << EOF
        NODE_ENV=test
        PORT=3000
        
        # PostgreSQL
        PGHOST=localhost
        PGPORT=5432
        PGUSER=postgres
        PGPASSWORD=postgres
        PGDATABASE=movie_db
        PG_ADMIN_USER=postgres
        PG_ADMIN_PASSWORD=postgres
        APP_DB_PW=apppass
        ADMIN_DB_PW=adminpass
        DATABASE_URL=postgresql://postgres:postgres@localhost:5432/movie_db
        
        # MongoDB
        MON_HOST=localhost
        MON_PORT=27018
        MON_USERNAME=admin
        MON_PASSWORD=adminpass
        MONGODB_URI=mongodb://admin:adminpass@localhost:27018/movie_db?authSource=admin
        
        # Neo4j
        NEO4J_URI=bolt://localhost:7687
        NEO4J_USER=neo4j
        NEO4J_PASSWORD=testpassword
        NEO4J_AUTH=neo4j/testpassword
        NEO4J_HEAP_INITIAL_SIZE=512M
        NEO4J_HEAP_MAX_SIZE=1G
        NEO4J_PAGECACHE_SIZE=512M
        
        # JWT
        JWT_SECRET=test-secret-key-for-ci
        JWT_EXPIRES_IN=1h
        
        # PgAdmin (not needed for tests)
        PGADMIN_DEFAULT_EMAIL=admin@admin.com
        PGADMIN_DEFAULT_PASSWORD=admin
        EOF

    - name: Generate Prisma Client
      run: npm run db:generate

    - name: Initialize database schema
      run: |
        # Run the SQL initialization scripts in order
        echo "Installing PostgreSQL client..."
        sudo apt-get update && sudo apt-get install -y postgresql-client
        
        echo "Initializing database schema..."
        cd db/sql/postgres
        
        # Run SQL files in order (skip .txt and .sh files)
        for file in 01_schema.sql 03_views.sql 04_procs_funcs.sql 05_triggers.sql 06_events.sql 07_users_privs.sql 08_fulltext.sql 09_user_account.sql; do
          if [ -f "$file" ]; then
            echo "Running $file..."
            PGPASSWORD=postgres psql -h localhost -U postgres -d movie_db -f "$file" || echo "Warning: $file failed, continuing..."
          fi
        done
        cd ../../..
      continue-on-error: true

    - name: Seed database (if seed script exists)
      run: |
        if [ -f "prisma/seed.ts" ]; then
          npm run db:seed || echo "Seed script failed or not needed"
        fi
      continue-on-error: true

    - name: Wait for services to be ready
      run: |
        echo "Waiting for services..."
        sleep 10

    - name: Run integration tests with coverage
      run: npm run test:integration:coverage
      env:
        CI: true

    - name: Upload coverage reports
      if: always() && hashFiles('coverage/**/*') != ''
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage/
