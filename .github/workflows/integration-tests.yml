name: Integration Tests

on:
  push:
    branches: [ main, master, Mikkel_branch_1 ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: movie_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      mongodb:
        image: mongo:latest
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: adminpass
        ports:
          - 27018:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand({ping: 1})'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      neo4j:
        image: neo4j:5.13-community
        env:
          NEO4J_AUTH: neo4j/testpassword
          NEO4J_ACCEPT_LICENSE_AGREEMENT: yes
        ports:
          - 7474:7474
          - 7687:7687
        options: >-
          --health-cmd "cypher-shell -u neo4j -p testpassword 'RETURN 1'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Setup environment variables
      run: |
        cat > .env << EOF
        NODE_ENV=test
        PORT=3000
        
        # PostgreSQL
        PG_ADMIN_USER=postgres
        PG_ADMIN_PASSWORD=postgres
        PGDATABASE=movie_db
        APP_DB_PW=apppass
        ADMIN_DB_PW=adminpass
        DATABASE_URL=postgresql://postgres:postgres@localhost:5432/movie_db
        
        # MongoDB
        MON_HOST=localhost
        MON_PORT=27018
        MON_USERNAME=admin
        MON_PASSWORD=adminpass
        MONGODB_URI=mongodb://admin:adminpass@localhost:27018/movie_db?authSource=admin
        
        # Neo4j
        NEO4J_URI=bolt://localhost:7687
        NEO4J_USER=neo4j
        NEO4J_PASSWORD=testpassword
        NEO4J_AUTH=neo4j/testpassword
        NEO4J_HEAP_INITIAL_SIZE=512M
        NEO4J_HEAP_MAX_SIZE=1G
        NEO4J_PAGECACHE_SIZE=512M
        
        # JWT
        JWT_SECRET=test-secret-key-for-ci
        JWT_EXPIRES_IN=1h
        
        # PgAdmin (not needed for tests)
        PGADMIN_DEFAULT_EMAIL=admin@admin.com
        PGADMIN_DEFAULT_PASSWORD=admin
        EOF

    - name: Generate Prisma Client
      run: npm run db:generate

    - name: Run database migrations
      run: npm run db:migrate:deploy
      continue-on-error: true

    - name: Wait for services to be ready
      run: |
        echo "Waiting for services..."
        sleep 10

    - name: Run integration tests
      run: npm test
      env:
        CI: true

    - name: Upload coverage reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage/
